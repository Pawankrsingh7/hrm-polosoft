<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Details | HR Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-50: #eef2ff;
      --primary-100: #e0e7ff;
      --primary-200: #c7d2fe;
      --primary-300: #a5b4fc;
      --primary-400: #818cf8;
      --primary-500: #6366f1;
      --primary-600: #4f46e5;
      --primary-700: #4338ca;
      --primary-800: #3730a3;
      --primary-900: #312e81;
      
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      --success-50: #f0fdf4;
      --success-500: #22c55e;
      --success-600: #16a34a;
      --success-700: #15803d;
      
      --warning-50: #fffbeb;
      --warning-500: #f59e0b;
      --warning-600: #d97706;
      
      --error-50: #fef2f2;
      --error-500: #ef4444;
      --error-600: #dc2626;
      
      --info-50: #eff6ff;
      --info-500: #3b82f6;
      
      --border-radius-lg: 20px;
      --border-radius-md: 14px;
      --border-radius-sm: 10px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(145deg, #f3f4f6 0%, #e5e7eb 100%);
      color: var(--gray-800);
      min-height: 100vh;
    }

    /* Header Styles */
    .page-header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      color: var(--gray-700);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
      color: var(--primary-600);
      transform: translateX(-2px);
    }

    .header-title h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-800);
      margin: 0;
    }

    .header-title p {
      font-size: 14px;
      color: var(--gray-500);
      margin: 4px 0 0;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .header-btn {
      height: 40px;
      padding: 0 16px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--gray-200);
      background: white;
      color: var(--gray-700);
      transition: all 0.2s;
    }

    .header-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .header-btn.primary {
      background: var(--primary-600);
      border-color: var(--primary-600);
      color: white;
    }

    .header-btn.primary:hover {
      background: var(--primary-700);
      border-color: var(--primary-700);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    /* Main Container */
    .main-container {
      max-width: 1600px;
      margin: 24px auto;
      padding: 0 24px;
    }

    /* Company Banner */
    .company-banner {
      background: linear-gradient(145deg, var(--primary-900), var(--primary-800));
      border-radius: var(--border-radius-lg);
      padding: 32px;
      margin-bottom: 24px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-lg);
    }

    .company-info h2 {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 8px;
      letter-spacing: -0.5px;
    }

    .company-info p {
      font-size: 16px;
      opacity: 0.9;
      margin: 0;
    }

    .company-logo {
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: 700;
      color: white;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    /* Employee Profile Card */
    .profile-card {
      background: white;
      border-radius: var(--border-radius-lg);
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
    }

    .profile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 700;
      color: white;
      box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4);
    }

    .profile-details h3 {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-800);
      margin: 0 0 8px;
    }

    .profile-meta {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--gray-600);
      font-size: 14px;
    }

    .meta-item i {
      color: var(--primary-500);
      font-size: 16px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-badge.verified {
      background: var(--success-50);
      color: var(--success-700);
      border: 1px solid var(--success-200);
    }

    .status-badge.pending {
      background: var(--warning-50);
      color: var(--warning-700);
      border: 1px solid var(--warning-200);
    }

    .status-badge.rejected {
      background: var(--error-50);
      color: var(--error-700);
      border: 1px solid var(--error-200);
    }

    .print-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      color: var(--gray-700);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .print-btn:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
      color: var(--primary-600);
    }

    .revert-reject-btn {
      height: 44px;
      border-radius: 12px;
      padding: 0 14px;
      background: var(--error-50);
      border: 1px solid #fecaca;
      color: var(--error-700);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .revert-reject-btn:hover {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #991b1b;
    }

    /* Section Styles */
    .section-card {
      background: white;
      border-radius: var(--border-radius-lg);
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .section-header {
      padding: 18px 24px;
      background: linear-gradient(90deg, var(--gray-50), white);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-icon {
      width: 40px;
      height: 40px;
      background: var(--primary-50);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-600);
      font-size: 20px;
    }

    .section-header h2 {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-700);
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-content {
      padding: 24px;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .info-item {
      background: var(--gray-50);
      border-radius: var(--border-radius-sm);
      padding: 16px;
      border: 1px solid var(--gray-200);
      transition: all 0.2s;
    }

    .info-item:hover {
      border-color: var(--primary-300);
      box-shadow: var(--shadow-sm);
      transform: translateY(-2px);
    }

    .info-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .info-value {
      font-size: 15px;
      font-weight: 500;
      color: var(--gray-800);
      word-break: break-word;
    }

    .info-value.na {
      color: var(--gray-400);
      font-style: italic;
    }

    /* Table Styles */
    .table-responsive {
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--gray-200);
    }

    .data-table {
      margin: 0;
      width: 100%;
    }

    .data-table thead th {
      background: var(--gray-50);
      color: var(--gray-600);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 16px;
      border-bottom: 1px solid var(--gray-200);
    }

    .data-table tbody td {
      padding: 16px;
      font-size: 14px;
      color: var(--gray-700);
      border-bottom: 1px solid var(--gray-100);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    .data-table tbody tr:hover td {
      background: var(--primary-50);
    }

    /* Review Panel */
    .review-panel {
      background: white;
      border-radius: var(--border-radius-lg);
      padding: 28px;
      margin-top: 24px;
      box-shadow: var(--shadow-md);
      border: 2px solid var(--primary-200);
      position: relative;
    }

    .review-panel::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }

    .review-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-700);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .review-title i {
      font-size: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
      display: block;
    }

    .form-control {
      height: 48px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      padding: 0 16px;
      font-size: 15px;
      transition: all 0.2s;
    }

    .form-control:focus {
      border-color: var(--primary-400);
      box-shadow: 0 0 0 3px var(--primary-100);
      outline: none;
    }

    .form-check {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0;
    }

    .form-check-input {
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 6px;
      cursor: pointer;
    }

    .form-check-input:checked {
      background-color: var(--primary-600);
      border-color: var(--primary-600);
    }

    .form-check-label {
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
    }

    .muted-help {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 8px;
    }

    .action-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      height: 44px;
      padding: 0 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-danger {
      background: white;
      border: 1px solid var(--error-200);
      color: var(--error-600);
    }

    .btn-danger:hover {
      background: var(--error-50);
      border-color: var(--error-300);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .btn-success {
      background: var(--success-600);
      border: 1px solid var(--success-600);
      color: white;
    }

    .btn-success:hover {
      background: var(--success-700);
      border-color: var(--success-700);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    }

    /* Loading State */
    .loading-state {
      background: white;
      border-radius: var(--border-radius-lg);
      padding: 60px;
      text-align: center;
      box-shadow: var(--shadow-md);
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary-600);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    /* Hidden PDF Export Layout */
    .pdf-export-sheet {
      width: 794px; /* ~A4 at 96dpi */
      background: #f3f5f9;
      color: #0f172a;
      font-family: 'Inter', sans-serif;
      padding: 28px;
    }

    .pdf-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 18px;
      padding-bottom: 14px;
      border-bottom: 2px solid #dbe3f3;
    }

    .pdf-title {
      font-size: 22px;
      font-weight: 800;
      color: #1d4ed8;
      margin: 0 0 4px;
    }

    .pdf-subtitle {
      font-size: 12px;
      color: #475569;
      margin: 0;
    }

    .pdf-section {
      background: #ffffff;
      border: 1px solid #d9e1ee;
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
      page-break-inside: avoid;
    }

    .pdf-section-head {
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 14px;
      font-weight: 700;
      padding: 8px 12px;
      border-bottom: 1px solid #d9e1ee;
    }

    .pdf-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 16px;
      padding: 10px 12px;
    }

    .pdf-item {
      font-size: 12px;
      line-height: 1.4;
      color: #111827;
      word-break: break-word;
    }

    .pdf-item strong {
      color: #1f2937;
    }

    .pdf-entry-list {
      padding: 10px 12px;
    }

    .pdf-entry {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #f8fafc;
      page-break-inside: avoid;
    }

    .pdf-entry:last-child {
      margin-bottom: 0;
    }

    .pdf-entry-title {
      font-size: 12px;
      font-weight: 700;
      color: #1e3a8a;
      margin-bottom: 6px;
    }

    .pdf-table-wrap {
      padding: 10px 12px;
    }

    .pdf-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #d9e1ee;
      border-radius: 8px;
      overflow: hidden;
      table-layout: fixed;
    }

    .pdf-table thead th {
      background: #f1f5f9;
      color: #334155;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-weight: 700;
      padding: 9px 8px;
      border-bottom: 1px solid #d9e1ee;
      text-align: left;
    }

    .pdf-table tbody td {
      background: #ffffff;
      color: #111827;
      font-size: 11.5px;
      padding: 9px 8px;
      border-bottom: 1px solid #e5e7eb;
      word-break: break-word;
      vertical-align: top;
    }

    .pdf-table tbody tr:last-child td {
      border-bottom: none;
    }

    .pdf-page-break-before {
      page-break-before: always;
      break-before: page;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Print Styles */
    @media print {
      .page-header,
      .company-banner,
      .review-panel,
      .back-btn,
      .header-actions,
      .print-btn {
        display: none !important;
      }

      .main-container {
        max-width: 100%;
        padding: 0;
        margin: 0;
      }

      .profile-card,
      .section-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
        margin-bottom: 16px;
      }

      .profile-avatar {
        background: #f0f0f0;
        color: #333;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        padding: 0 16px;
      }

      .profile-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .profile-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .profile-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .company-banner {
        flex-direction: column;
        text-align: center;
        gap: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-left">
        <a id="backBtn" class="back-btn" href="/admin" title="Back to Dashboard">
          <i class="bi bi-arrow-left"></i>
        </a>
        <div class="header-title">
          <h1>Employee Details</h1>
          <p>Review and manage employee information</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" id="refreshBtn">
          <i class="bi bi-arrow-clockwise"></i>
          Refresh
        </button>
        <button class="header-btn primary" id="printDetailsBtn">
          <i class="bi bi-download"></i>
          Download PDF
        </button>
      </div>
    </div>
  </header>

  <main class="main-container">
    <!-- Company Banner -->
    <div class="company-banner">
      <div class="company-info">
        <h2>Employee Onboarding Application</h2>
        <p>Complete employee profile and verification details</p>
      </div>
      <div class="company-logo">
        <span>HR</span>
      </div>
    </div>

    <!-- Content Area -->
    <div id="detailsRoot">
      <!-- Dynamic content will be inserted here -->
    </div>

    <!-- Review Panel (initially hidden, shown by JS) -->
    <div class="review-panel" id="reviewPanel" style="display: none;">
      <div class="review-title">
        <i class="bi bi-shield-check"></i>
        Review & Decision
      </div>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label" for="reviewerName">
              <i class="bi bi-person-badge me-2"></i>Reviewer Name
            </label>
            <input id="reviewerName" type="text" class="form-control" placeholder="Enter your full name" />
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="allChecked" />
              <label class="form-check-label" for="allChecked">
                <strong>All information verified and checked properly</strong>
              </label>
            </div>
            <div class="muted-help">
              <i class="bi bi-info-circle me-1"></i>
              Please verify each section before making a decision
            </div>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button id="rejectBtn" class="btn btn-danger">
          <i class="bi bi-x-circle"></i>
          Reject Application
        </button>
        <button id="verifyBtn" class="btn btn-success">
          <i class="bi bi-check-circle"></i>
          Approve & Verify
        </button>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    const detailsRoot = document.getElementById("detailsRoot");
    const reviewPanel = document.getElementById("reviewPanel");
    const reviewerNameEl = document.getElementById("reviewerName");
    const allCheckedEl = document.getElementById("allChecked");
    const verifyBtn = document.getElementById("verifyBtn");
    const rejectBtn = document.getElementById("rejectBtn");
    const backBtn = document.getElementById("backBtn");
    const printBtn = document.getElementById("printDetailsBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    
    let submissionId = null;
    let currentRow = null;

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function displayValue(value) {
      if (value === null || value === undefined) return "N/A";
      const text = String(value).trim();
      return text ? escapeHtml(text) : "N/A";
    }

    function formatDateTime(value) {
      if (!value) return "N/A";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return displayValue(value);
      return escapeHtml(
        date.toLocaleString("en-IN", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true
        })
      );
    }

    function statusBadge(status) {
      const normalized = String(status || "Pending");
      const lower = normalized.toLowerCase();
      const cls = lower === "verified" ? "status-badge verified" : 
                 lower === "rejected" ? "status-badge rejected" : 
                 "status-badge pending";
      const icon = lower === "verified" ? "bi-check-circle-fill" : 
                  lower === "rejected" ? "bi-x-circle-fill" : 
                  "bi-exclamation-circle-fill";
      return `<span class="${cls}"><i class="bi ${icon}"></i>${escapeHtml(normalized)}</span>`;
    }

    function createInfoItem(label, value) {
      const val = displayValue(value);
      const naClass = val === "N/A" ? "na" : "";
      return `
        <div class="info-item">
          <div class="info-label">${escapeHtml(label)}</div>
          <div class="info-value ${naClass}">${val}</div>
        </div>
      `;
    }

    function createSection(title, icon, content) {
      return `
        <div class="section-card">
          <div class="section-header">
            <div class="section-icon">
              <i class="bi ${icon}"></i>
            </div>
            <h2>${escapeHtml(title)}</h2>
          </div>
          <div class="section-content">
            ${content}
          </div>
        </div>
      `;
    }

    function createTable(headers, rows) {
      return `
        <div class="table-responsive">
          <table class="table data-table">
            <thead>
              <tr>
                ${headers.map(h => `<th>${escapeHtml(h)}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${rows.map(row => `
                <tr>
                  ${row.map(cell => `<td>${displayValue(cell)}</td>`).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function textOrNA(value) {
      if (value === null || value === undefined) return "N/A";
      const text = String(value).trim();
      return text || "N/A";
    }

    function buildPdfSection(title, pairs) {
      const items = pairs.map(([label, value]) => `
        <div class="pdf-item"><strong>${escapeHtml(label)}:</strong> ${escapeHtml(textOrNA(value))}</div>
      `).join("");

      return `
        <section class="pdf-section" data-pdf-block="1">
          <div class="pdf-section-head">${escapeHtml(title)}</div>
          <div class="pdf-grid">${items}</div>
        </section>
      `;
    }

    function buildPdfTableSection(title, headers, entries, mapEntryToCells) {
      if (!entries.length) {
        return `
          <section class="pdf-section" data-pdf-block="1">
            <div class="pdf-section-head">${escapeHtml(title)}</div>
            <div class="pdf-table-wrap"><div class="pdf-item">No data available</div></div>
          </section>
        `;
      }

      const headerHtml = headers.map((header) => `<th>${escapeHtml(header)}</th>`).join("");
      const bodyHtml = entries.map((entry) => {
        const cells = mapEntryToCells(entry).map((value) => `<td>${escapeHtml(textOrNA(value))}</td>`).join("");
        return `<tr>${cells}</tr>`;
      }).join("");

      return `
        <section class="pdf-section" data-pdf-block="1">
          <div class="pdf-section-head">${escapeHtml(title)}</div>
          <div class="pdf-table-wrap">
            <table class="pdf-table">
              <thead><tr>${headerHtml}</tr></thead>
              <tbody>${bodyHtml}</tbody>
            </table>
          </div>
        </section>
      `;
    }

    function buildPdfTemplate(row) {
      const payload = row.payload || {};
      const personal = payload.personal || {};
      const employeeDetails = payload.employeeDetails || {};
      const address = payload.address || {};
      const identification = payload.identification || {};
      const bank = payload.bank || {};
      const education = Array.isArray(payload.education) ? payload.education : [];
      const experience = Array.isArray(payload.experience) ? payload.experience : [];
      const other = payload.other || {};

      const resolvedEmployeeId = employeeDetails.employeeId || row.employee_id || personal.employeeId || "";
      const resolvedCompanyEmail = employeeDetails.companyEmail || address.companyEmail || row.company_email || "";
      const fullName = row.full_name || personal.fullName || "";
      const currentStatus = String(row.status || "Pending").toLowerCase();
      const canRevertReject = currentStatus === "verified";

      const status = String(row.status || "Pending");

      let html = `
        <div class="pdf-export-sheet" id="pdfExportSheet">
          <div class="pdf-header" data-pdf-block="1">
            <div>
              <h1 class="pdf-title">Employee Details Report</h1>
              <p class="pdf-subtitle">${escapeHtml(textOrNA(fullName))} | ID: ${escapeHtml(textOrNA(resolvedEmployeeId))}</p>
            </div>
          </div>

          ${buildPdfSection("Personal Information", [
            ["Salutation", personal.salutation],
            ["Full Name", personal.fullName],
            ["Father's Name", personal.fatherName],
            ["Contact Number", personal.contactNumber],
            ["Gender", personal.gender],
            ["Marital Status", personal.maritalStatus],
            ["Date of Birth", personal.dateOfBirth],
            ["Blood Group", personal.bloodGroup],
            ["Emergency Contact", personal.emergencyContactName],
            ["Emergency Contact Number", personal.emergencyContactNumber],
            ["Emergency Contact Relation", personal.emergencyContactRelation]
          ])}

          ${buildPdfSection("Employee Details", [
            ["Employee ID", resolvedEmployeeId],
            ["Date of Joining", employeeDetails.dateOfJoining],
            ["Personal Email", employeeDetails.personalEmail || address.personalEmail || row.personal_email],
            ["Company Email", resolvedCompanyEmail]
          ])}

          ${buildPdfSection("Address Details", [
            ["Current Address", address.currentAddress],
            ["Permanent Address", address.permanentAddress],
            ["Country", address.country],
            ["State", address.state],
            ["District", address.district],
            ["City", address.city],
            ["Pincode", address.pincode]
          ])}

          ${buildPdfSection("Identification Details", [
            ["Aadhar Number", identification.aadharNumber],
            ["PAN Number", identification.panNumber],
            ["UAN Number", identification.uanNumber],
            ["Passport Number", identification.passportNumber],
            ["Passport Valid Upto", identification.passportValidUpto]
          ])}

          ${buildPdfSection("Bank Details", [
            ["Bank Name", bank.bankName],
            ["Account Number", bank.accountNumber],
            ["IFSC Code", bank.ifscCode],
            ["Bank Holder Name", bank.bankHolderName]
          ])}

          ${buildPdfTableSection(
            "Education Details",
            ["Level", "Qualification", "Specialization", "Year", "Board/University", "CGPA/%"],
            education,
            (edu) => [
              edu.level,
              edu.qualification,
              edu.specialization,
              edu.yearOfPassing,
              edu.boardUniversity,
              edu.cgpa
            ]
          )}

          ${buildPdfTableSection(
            "Work Experience",
            ["Organization", "Designation", "From Date", "To Date", "Company Address", "Company Contact", "CTC", "Reason For Leaving"],
            experience,
            (exp) => [
              exp.organization,
              exp.designation,
              exp.fromDate,
              exp.toDate || "Present",
              exp.experienceAddress,
              exp.companyContact,
              exp.ctc,
              exp.reasonForLeaving
            ]
          ).replace('<section class=\"pdf-section\"', '<section class=\"pdf-section pdf-page-break-before\"')}
      `;

      if (status.toLowerCase() === "verified" || status.toLowerCase() === "rejected") {
        html += buildPdfSection("Review Decision", [
          ["Final Status", row.status],
          ["Reviewer Name", row.reviewer_name],
          ["Review Note", status.toLowerCase() === "rejected" ? (row.rejection_reason || "N/A") : "Verified by reviewer"],
          ["Reviewed At", row.reviewed_at]
        ]);
      }

      html += buildPdfSection("Submission Metadata", [
        ["Submitted At", row.created_at],
        ["Details Confirmation", other.detailsConfirmation ? "Yes" : "No"]
      ]);

      html += `</div>`;
      return html;
    }

    function renderDetails(row) {
      const payload = row.payload || {};
      const personal = payload.personal || {};
      const employeeDetails = payload.employeeDetails || {};
      const address = payload.address || {};
      const identification = payload.identification || {};
      const bank = payload.bank || {};
      const education = (Array.isArray(payload.education) ? payload.education : []).filter((edu) =>
        [edu?.level, edu?.qualification, edu?.specialization, edu?.yearOfPassing, edu?.boardUniversity, edu?.cgpa]
          .some((value) => String(value || "").trim())
      );
      const experience = (Array.isArray(payload.experience) ? payload.experience : []).filter((exp) =>
        [exp?.organization, exp?.designation, exp?.fromDate, exp?.toDate, exp?.experienceAddress, exp?.companyContact, exp?.ctc, exp?.reasonForLeaving]
          .some((value) => String(value || "").trim())
      );
      const other = payload.other || {};

      const resolvedEmployeeId = employeeDetails.employeeId || row.employee_id || personal.employeeId || "";
      const resolvedPersonalEmail = employeeDetails.personalEmail || address.personalEmail || row.personal_email || "";
      const resolvedCompanyEmail = employeeDetails.companyEmail || address.companyEmail || row.company_email || "";
      const fullName = row.full_name || personal.fullName || "";
      const currentStatus = String(row.status || "Pending").toLowerCase();
      const canRevertReject = currentStatus === "verified";

      // Profile Card
      let html = `
        <div class="profile-card">
          <div class="profile-header">
            <div class="profile-info">
              <div class="profile-avatar">${fullName ? fullName.charAt(0).toUpperCase() : 'E'}</div>
              <div class="profile-details">
                <h3>${displayValue(fullName)}</h3>
                <div class="profile-meta">
                  <span class="meta-item">
                    <i class="bi bi-building"></i>
                    ID: ${displayValue(resolvedEmployeeId)}
                  </span>
                  <span class="meta-item">
                    <i class="bi bi-calendar"></i>
                    Submitted: ${formatDateTime(row.created_at)}
                  </span>
                </div>
              </div>
            </div>
            <div class="d-flex align-items-center gap-3">
              <button id="printBtn" class="print-btn" title="Download PDF">
                <i class="bi bi-printer"></i>
              </button>
              ${
                canRevertReject
                  ? `<button id="revertRejectBtn" class="revert-reject-btn" title="Move verified employee to rejected">
                      <i class="bi bi-arrow-counterclockwise"></i>
                      Revert & Reject
                    </button>`
                  : ""
              }
              ${statusBadge(row.status)}
            </div>
          </div>
        </div>
      `;

      // Personal Information Section
      let personalItems = [
        createInfoItem("Salutation", personal.salutation),
        createInfoItem("Full Name", personal.fullName),
        createInfoItem("Father's Name", personal.fatherName),
        createInfoItem("Contact Number", personal.contactNumber),
        createInfoItem("Gender", personal.gender),
        createInfoItem("Marital Status", personal.maritalStatus),
        createInfoItem("Date of Birth", personal.dateOfBirth),
        createInfoItem("Blood Group", personal.bloodGroup),
        createInfoItem("Emergency Contact", personal.emergencyContactName),
        createInfoItem("Emergency Number", personal.emergencyContactNumber),
        createInfoItem("Emergency Relation", personal.emergencyContactRelation)
      ];
      html += createSection("Personal Information", "bi-person", `<div class="info-grid">${personalItems.join('')}</div>`);

      // Employee Details Section
      let employeeItems = [
        createInfoItem("Employee ID", resolvedEmployeeId),
        createInfoItem("Date of Joining", employeeDetails.dateOfJoining),
        createInfoItem("Personal Email", resolvedPersonalEmail),
        createInfoItem("Company Email", resolvedCompanyEmail)
      ];
      html += createSection("Employment Details", "bi-briefcase", `<div class="info-grid">${employeeItems.join('')}</div>`);

      // Address Section
      let addressItems = [
        createInfoItem("Current Address", address.currentAddress),
        createInfoItem("Permanent Address", address.permanentAddress),
        createInfoItem("Country", address.country),
        createInfoItem("State", address.state),
        createInfoItem("District", address.district),
        createInfoItem("City", address.city),
        createInfoItem("Pincode", address.pincode)
      ];
      html += createSection("Address Information", "bi-geo-alt", `<div class="info-grid">${addressItems.join('')}</div>`);

      // Identification Section
      let idItems = [
        createInfoItem("Aadhar Number", identification.aadharNumber),
        createInfoItem("UAN Number", identification.uanNumber),
        createInfoItem("PAN Number", identification.panNumber),
        createInfoItem("Passport Number", identification.passportNumber),
        createInfoItem("Passport Valid Until", identification.passportValidUpto)
      ];
      html += createSection("Identification", "bi-card-text", `<div class="info-grid">${idItems.join('')}</div>`);

      // Bank Details Section
      let bankItems = [
        createInfoItem("Bank Name", bank.bankName),
        createInfoItem("Account Number", bank.accountNumber),
        createInfoItem("IFSC Code", bank.ifscCode),
        createInfoItem("Account Holder", bank.bankHolderName)
      ];
      html += createSection("Bank Details", "bi-bank", `<div class="info-grid">${bankItems.join('')}</div>`);

      // Education Section
      if (education.length) {
        const headers = ["Level", "Qualification", "Specialization", "Year", "Board/University", "CGPA/%"];
        const rows = education.map(edu => [
          edu.level,
          edu.qualification,
          edu.specialization,
          edu.yearOfPassing,
          edu.boardUniversity,
          edu.cgpa
        ]);
        html += createSection("Education History", "bi-mortarboard", createTable(headers, rows));
      } else {
        html += createSection("Education Details", "bi-mortarboard", `<p class="text-muted p-3">No education details provided</p>`);
      }

      // Experience Section
      if (experience.length) {
        const headers = ["Organization", "Designation", "From", "To", "Address", "Contact", "CTC", "Reason"];
        const rows = experience.map(exp => [
          exp.organization,
          exp.designation,
          exp.fromDate,
          exp.toDate || "Present",
          exp.experienceAddress,
          exp.companyContact,
          exp.ctc,
          exp.reasonForLeaving
        ]);
        html += createSection("Work Experience", "bi-clock-history", createTable(headers, rows));
      } else {
        html += createSection("Work Experience", "bi-clock-history", `<p class="text-muted p-3">No work experience provided</p>`);
      }

      // Review Decision Section (if already reviewed)
      const status = String(row.status || "Pending").toLowerCase();
      if (status === "verified" || status === "rejected") {
        let reviewItems = [
          createInfoItem("Final Status", row.status),
          createInfoItem("Reviewer", row.reviewer_name),
          createInfoItem("Review Note", status === "rejected" ? (row.rejection_reason || "N/A") : "Verified by reviewer"),
          createInfoItem("Reviewed At", formatDateTime(row.reviewed_at))
        ];
        html += createSection("Review Decision", "bi-shield-check", `<div class="info-grid">${reviewItems.join('')}</div>`);
      }

      detailsRoot.innerHTML = html;
    }

    async function loadSubmission() {
      detailsRoot.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p style="color: var(--gray-500);">Loading employee details...</p>
        </div>
      `;

      const match = window.location.pathname.match(/\/admin\/submissions\/(\d+)/);
      submissionId = match ? Number(match[1]) : null;
      
      if (!submissionId) {
        detailsRoot.innerHTML = `<div class="alert alert-danger">Invalid submission ID</div>`;
        return;
      }

      try {
        const response = await fetch(`/api/admin/submissions/${submissionId}`, { credentials: "include" });
        if (!response.ok) {
          const data = await response.json().catch(() => ({}));
          detailsRoot.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.message || "Failed to load submission")}</div>`;
          return;
        }
        
        const data = await response.json();
        currentRow = data.row;
        renderDetails(data.row || {});
        
        const status = String(data.row?.status || "Pending").toLowerCase();
        reviewPanel.style.display = (status === "verified" || status === "rejected") ? "none" : "block";
      } catch (error) {
        detailsRoot.innerHTML = `<div class="alert alert-danger">Error loading data</div>`;
      }
    }

    function validateReviewInputs() {
      const reviewerName = reviewerNameEl.value.trim();
      const allChecked = allCheckedEl.checked;
      
      if (!reviewerName) {
        alert("Please enter reviewer name");
        return null;
      }
      if (!allChecked) {
        alert("Please confirm that all information is checked properly");
        return null;
      }
      return { reviewerName, allChecked };
    }

    async function verifySubmission() {
      const values = validateReviewInputs();
      if (!values) return;

      const confirmed = window.confirm("Are you sure you want to approve this employee?");
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/admin/submissions/${submissionId}/verify`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(values)
        });
        
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          alert(data.message || "Failed to verify submission");
          return;
        }
        
        alert("Employee successfully verified!");
        window.location.href = "/admin?status=verified";
      } catch (error) {
        alert("Failed to verify submission");
      }
    }

    async function rejectSubmission() {
      const values = validateReviewInputs();
      if (!values) return;

      const reason = window.prompt("Please enter reason for rejection:");
      if (reason === null) return;
      if (!reason.trim()) {
        alert("Rejection reason is required");
        return;
      }

      try {
        const response = await fetch(`/api/admin/submissions/${submissionId}/reject`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ ...values, rejectionReason: reason.trim() })
        });
        
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          alert(data.message || "Failed to reject submission");
          return;
        }
        
        alert("Employee successfully rejected!");
        window.location.href = "/admin?status=rejected";
      } catch (error) {
        alert("Failed to reject submission");
      }
    }

    async function revertRejectSubmission() {
      const reviewerName = window.prompt("Enter reviewer name:");
      if (reviewerName === null) return;
      if (!reviewerName.trim()) {
        alert("Reviewer name is required");
        return;
      }

      const reason = window.prompt("Enter reason for revert to rejected:");
      if (reason === null) return;
      if (!reason.trim()) {
        alert("Rejection reason is required");
        return;
      }

      const confirmed = window.confirm(
        "This will move this verified employee to rejected status. Continue?"
      );
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/admin/submissions/${submissionId}/revert-reject`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            reviewerName: reviewerName.trim(),
            rejectionReason: reason.trim()
          })
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          alert(data.message || "Failed to revert employee");
          return;
        }

        alert("Employee moved to rejected successfully");
        window.location.href = "/admin?status=rejected";
      } catch (error) {
        alert("Failed to revert employee");
      }
    }

    async function downloadAsPdf() {
      if (!window.jspdf || !window.jspdf.jsPDF || !window.html2canvas) {
        alert("PDF library not loaded");
        return;
      }

      const printBtn = document.getElementById("printBtn");
      if (printBtn) printBtn.disabled = true;

      const safeFileToken = (value, fallback) => {
        const normalized = String(value || "")
          .trim()
          .replace(/\s+/g, "_")
          .replace(/[^a-zA-Z0-9_\-]/g, "");
        return normalized || fallback;
      };

      const employeeId = safeFileToken(
        currentRow?.employee_id || currentRow?.payload?.personal?.employeeId,
        "Employee"
      );
      const fullName = safeFileToken(
        currentRow?.full_name || currentRow?.payload?.personal?.fullName,
        "Details"
      );
      const filename = `${employeeId}_${fullName}.pdf`;
      let tempContainer = null;

      try {
        // Fetch latest details from DB before export
        const latestResponse = await fetch(`/api/admin/submissions/${submissionId}`, { credentials: "include" });
        if (latestResponse.ok) {
          const latestData = await latestResponse.json().catch(() => null);
          if (latestData?.row) {
            currentRow = latestData.row;
          }
        }

        tempContainer = document.createElement("div");
        tempContainer.style.position = "fixed";
        tempContainer.style.left = "-10000px";
        tempContainer.style.top = "0";
        tempContainer.style.zIndex = "-1";
        tempContainer.innerHTML = buildPdfTemplate(currentRow || {});
        document.body.appendChild(tempContainer);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4");

        const blocks = Array.from(tempContainer.querySelectorAll("[data-pdf-block='1']"));
        const firstPageBlocks = [];
        const secondPageBlocks = [];
        let movedToSecondPage = false;

        blocks.forEach((block) => {
          if (block.classList.contains("pdf-page-break-before")) {
            movedToSecondPage = true;
          }
          if (movedToSecondPage) {
            secondPageBlocks.push(block);
          } else {
            firstPageBlocks.push(block);
          }
        });

        const renderBlocksAsCanvas = async (targetBlocks) => {
          const pageContainer = document.createElement("div");
          pageContainer.style.width = "794px";
          pageContainer.style.background = "#f3f5f9";
          pageContainer.style.padding = "28px";
          targetBlocks.forEach((b) => pageContainer.appendChild(b.cloneNode(true)));
          tempContainer.appendChild(pageContainer);
          const canvas = await window.html2canvas(pageContainer, {
            scale: 2,
            backgroundColor: "#f3f5f9",
            logging: false,
            useCORS: true,
            windowWidth: 794
          });
          pageContainer.remove();
          return canvas;
        };

        const drawCanvasToPdf = (canvas, addNewPage) => {
          if (addNewPage) doc.addPage();
          const imgData = canvas.toDataURL("image/png");
          const pageWidth = 210;
          const pageHeight = 297;
          const margin = 8;
          const imgWidth = pageWidth - margin * 2;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;
          let position = margin;

          doc.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
          heightLeft -= (pageHeight - margin * 2);

          while (heightLeft > 0) {
            doc.addPage();
            position = margin - (imgHeight - heightLeft);
            doc.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
            heightLeft -= (pageHeight - margin * 2);
          }
        };

        const firstCanvas = await renderBlocksAsCanvas(firstPageBlocks);
        drawCanvasToPdf(firstCanvas, false);

        if (secondPageBlocks.length) {
          const secondCanvas = await renderBlocksAsCanvas(secondPageBlocks);
          drawCanvasToPdf(secondCanvas, true);
        }

        doc.save(filename);
      } catch (error) {
        console.error(error);
        alert("Failed to download PDF");
      } finally {
        if (tempContainer && tempContainer.parentNode) {
          tempContainer.parentNode.removeChild(tempContainer);
        }
        if (printBtn) printBtn.disabled = false;
      }
    }

    async function ensureLoggedIn() {
      try {
        const response = await fetch("/api/admin/me", { credentials: "include" });
        if (!response.ok) window.location.href = "/admin/login";
      } catch {
        window.location.href = "/admin/login";
      }
    }

    // Event Listeners
    verifyBtn.addEventListener("click", verifySubmission);
    rejectBtn.addEventListener("click", rejectSubmission);
    
    printBtn.addEventListener("click", downloadAsPdf);
    
    refreshBtn.addEventListener("click", () => {
      loadSubmission();
    });

    detailsRoot.addEventListener("click", (event) => {
      const printBtn = event.target.closest("#printBtn");
      if (printBtn) {
        downloadAsPdf();
      }

      const revertRejectBtn = event.target.closest("#revertRejectBtn");
      if (revertRejectBtn) {
        revertRejectSubmission();
      }
    });

    // Initialize
    (async function init() {
      await ensureLoggedIn();
      
      const urlParams = new URLSearchParams(window.location.search);
      const fromStatus = urlParams.get("fromStatus");
      backBtn.href = fromStatus ? `/admin?status=${encodeURIComponent(fromStatus)}` : "/admin";
      
      await loadSubmission();
    })();
  </script>
</body>
</html>
